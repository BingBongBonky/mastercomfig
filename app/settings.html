<!doctype html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="node_modules/xel/themes/material.css">
  <script src="node_modules/xel/xel.min.js"></script>
  <link href="node_modules/bootstrap/dist/css/bootstrap.min.css"
        integrity="sha256-zVUlvIh3NEZRYa9X/qpNY8P1aBy0d4FrI7bhfZSZVwc="
        crossorigin="anonymous" rel="stylesheet">
  <link href="third_party/font/overpass.css" rel="stylesheet">
  <link href="css/app.css" rel="stylesheet">
  <link href="css/settings.css" rel="stylesheet">
  <title>mastercomfig</title>
</head>
<body class="bg-light" style="padding-bottom: 40px;">
<nav class="navbar navbar-dark bg-dark d-flex align-items-center sticky-top"
     style="-webkit-app-region: drag; border-bottom: 1px solid #141414">
  <a href="#" id="slider-toggle">
    <x-icon name="menu" skin="titlebar"
            style="-webkit-app-region: no-drag"></x-icon>
  </a>
  <span class="navbar-brand">
    <img src="img/mastercomfig_logo_transparent.png" style="width: 30px;
    height: 30px" class="d-inline-block align-top" alt="">
    mastercomfig
  </span>
  <a href="#">
    <x-icon name="close" skin="titlebar" style="-webkit-app-region: no-drag"
            id="close-btn"></x-icon>
  </a>
</nav>
<ul class="nav flex-column position-fixed bg-dark text-light" id="slider"
    style="width:
30%; height: 100vh; z-index: 1000; left: -30%; border-right: 1px solid
#141414">
  <li class="nav-item" style="margin-top: 1rem;">
    <a class="nav-link no-link" href="mastercomfig.html">
      <x-icon
        name="home"></x-icon>
      Home</a>
  </li>
  <hr>
  <li class="nav-item">
    <a class="nav-link no-link" href="community.html">
      <x-icon
        name="share"></x-icon>
      Community</a>
  </li>
  <hr>
  <li class="nav-item">
    <a class="nav-link no-link active" href="#">
      <x-icon
        name="settings"></x-icon>
      Settings</a>
  </li>
  <hr>
  <li class="nav-item">
    <a class="nav-link no-link" href="news.html">
      <x-icon
        name="rss-feed"></x-icon>
      News</a>
  </li>
  <hr>
  <li class="nav-item">
    <a class="nav-link no-link" href="about.html">
      <x-icon
        name="info"></x-icon>
      About</a>
  </li>
  <hr>
</ul>
<div class="container"
     style="overflow-y: scroll; overflow-x: hidden; height: 85vh; padding-bottom: 48px;">
  <h1 class="display-4" id="title" style="margin-top: 20px">mastercomfig
                                                            settings</h1>
  <h3>Team Fortress 2 folder</h3>
  <div class="custom-file">
    <input type="file" class="custom-file-input" id="tf2-folder"
           webkitdirectory/>
    <label class="custom-file-label" for="tf2-folder" id="folder-label">Choose
                                                                        folder...</label>
  </div>
  <hr>
  <h3>Upload Speed</h3>
  <x-button id="speedtest-btn" style="margin-bottom: 4px">Run test</x-button>
  <div id="speedtest">
    <x-progressbar id="speedtest-bar" hidden></x-progressbar>
    <p>
      <small id="status">Clicking run test will access the Speedtest.net service
                         to record your upload speed.
      </small>
    </p>
  </div>
  <p id="speed"></p>
  <hr>
  <h3>Preset</h3>
  <x-select id="presets-select" style="width: 200px">
    <x-menu id="presets-menu">
    </x-menu>
  </x-select>
  <br>
  <x-button id="remove-modules">Reset to preset</x-button>
  <p>Removes any custom selections.</p>
  <x-button id="remove-customs">Clear Overrides</x-button>
  <p>Deletes all custom setting overrides.</p>
  <hr>
  <h3>User Preferences</h3>
  <div class="row">
    <div class="col">
      Dark Mode
    </div>
    <div class="col">
      <x-switch id="dark-mode"></x-switch>
    </div>
  </div>
  <div class="row">
    <div class="col">
      Analytics
    </div>
    <div class="col">
      <x-switch id="analytics"></x-switch>
    </div>
  </div>
  <hr>
  <h3>Advanced Options</h3>
  <div class="row">
    <div class="col">
      <x-button id="delete-this" style="margin-bottom: 1rem">Clear Settings
      </x-button>
      <p>Deletes all user settings so that the app has a clean state.</p>
    </div>
    <div class="col">
      <x-button id="dev-tools" style="margin-bottom: 1rem">Open Dev Tools
      </x-button>
      <p>Opens the Chrome Developer Tools for inspecting the app and viewing the
         console.</p>
    </div>
    <div class="col">
      <x-button id="clear-cache" style="margin-bottom: 1rem">Clear File Cache
      </x-button>
      <p>Removes all caching of config data and files downloaded from the
         Internet.</p>
    </div>
    <div class="col">
      <x-button id="reset-track" style="margin-bottom: 1rem">Reset tracking ID
      </x-button>
      <p>Resets your anonymous tracking ID used to track accurate user counts
         .</p>
    </div>
  </div>
</div>
<nav class="navbar fixed-bottom navbar-light bg-light" style="border-top: 1px
solid #141414">
  <div class="container">
    <a class="btn btn-outline-primary ml-auto" style="margin-left: 10px"
       href="mastercomfig.html">Close
    </a>
  </div>
</nav>
<x-notification id="error-notification" timeout="4000">
  An error occurred. Please try again later.
</x-notification>
<script src="js/module.js"></script>
<script src="node_modules/jquery/dist/jquery.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script src="node_modules/popper.js/dist/umd/popper.js"
        integrity="sha256-wqAoCRn9//AnHSl4qbXVhqdvmgFQqN5Elqp4Eb2wOXA="
        crossorigin="anonymous"></script>
<script src="node_modules/bootstrap/dist/js/bootstrap.min.js"
        integrity="sha256-IeI0loa35pfuDxqZbGhQUiZmD2Cywv1/bdqiypGW46o="
        crossorigin="anonymous"></script>
<script src="js/lib.js"></script>
<script src="js/titlebar.js"></script>
<script src="js/dark.js"></script>
<script>
  "use strict";

  $(() => {
    page();
  });

  function page() {

    if (visitor) {
      visitor.screenview("Settings").send();
    }

    document.getElementById("speed").innerHTML =
      "<strong>Download speed:</strong> " + settings.get("download-speed") +
      "Mbps";
    document.getElementById("speed").innerHTML +=
      "<br><strong>Upload speed:</strong> " + settings.get("upload-speed") +
      "Mbps";

    document.getElementById("folder-label").innerText =
      settings.get("tf2-folder");

    document.getElementById("tf2-folder").addEventListener("change", e => {
      let folder = e.target.files[0].path;
      if (e.target.files[0].name === "Team Fortress 2") {
        document.getElementById("folder-label").innerText = folder;
        settings.set("tf2-folder", folder);
      } else {
        document.getElementById("folder-label").innerText =
          "Invalid Team Fortress 2 folder. Please try again.";
      }
    });

    document.getElementById("delete-this").addEventListener("click", () => {
      settings.deleteAll();
      app.relaunch({args: process.argv.slice(1).concat(["--relaunch"])});
      app.exit(0);
    });

    document.getElementById("remove-modules").addEventListener("click", () => {
      settings.delete("modules");
      settings.delete("customs");
    });

    document.getElementById("remove-customs").addEventListener("click", () => {
      settings.delete("customs");
    });

    document.getElementById("dev-tools").addEventListener("click", () => {
      ipcRenderer.send("dev-tools-open");
    });

    document.getElementById("reset-track").addEventListener("click", () => {
      settings.set("tracking.uuid", uuid());
    });

    document.getElementById("clear-cache").addEventListener("click", () => {
      fs.remove(app.getPath("userData") + "/Comfig/", error => {
        if (error) handleException(error);
      });
    });

    var darkMode = document.getElementById("dark-mode");
    if (settings.get("ui.dark", false)) {
      darkMode.setAttribute("toggled", null);
    }
    darkMode.addEventListener("toggle", () => {
      var dark = darkMode.hasAttribute("toggled");
      settings.set("ui.dark", dark);
      darkify(dark);
    });

    var analyticsSwitch = document.getElementById("analytics");
    if (settings.get("tracking.consent", 1)) {
      analyticsSwitch.setAttribute("toggled", null);
    }
    analyticsSwitch.addEventListener("toggle", () => {
      var trackingLevel = analyticsSwitch.hasAttribute("toggled") ? 1 : 0;
      settings.set("tracking.consent", trackingLevel);
      if (!trackingLevel) {
        visitor = null;
      }
    });

    var speedtestBtn = document.getElementById("speedtest-btn");

    let retry = 0;

    speedtestBtn.addEventListener("click", () => {
      if (retry && visitor) {
        visitor.event({
          ec: "Speed measure",
          ea: "Retry",
          ev: retry
        }).send();
      }
      const speedtest = require("speedtest-net");
      var test = speedtest({
        pingCount: 10,
        serversUrl: "https://www.speedtest.net/speedtest-servers-static.php"
      });
      var server = document.getElementById("status");
      server.innerText = "Finding server...";

      var bar = document.getElementById("speedtest-bar");
      document.getElementById("speedtest-btn").disabled = true;
      bar.hidden = false;
      bar.removeAttribute("value");

      document.getElementById("speedtest").hidden = false;

      test.on("downloadprogress", progress => {
        bar.setAttribute("value", (parseFloat(progress) / 100).toString());
      });

      test.on("uploadprogress", progress => {
        bar.setAttribute("value", (parseFloat(progress) / 100).toString());
      });

      test.on("data", data => {
        bar.hidden = true;
        document.getElementById("speedtest").hidden = true;
        speedtestBtn.innerText = "Retry";
        speedtestBtn.disabled = false;
        retry++;
        var download = data.speeds.download;
        var upload = data.speeds.upload;
        document.getElementById("speed").hidden = false;
        document.getElementById("speed").innerHTML =
          "<strong>Download speed:</strong> " + download + "Mbps";
        document.getElementById("speed").innerHTML +=
          "<br><strong>Upload speed:</strong> " + upload + "Mbps";
        if (visitor) {
          visitor.event({
            ec: "Speed measure",
            ea: "Download speed",
            ev: download
          }).send();
          visitor.event({
            ec: "Speed measure",
            ea: "Upload speed",
            ev: upload
          }).send();
        }
        settings.set("upload-speed", upload);
        settings.set("download-speed", download);
      });

      test.on("testserver", testserver => {
        if (visitor) {
          visitor.event({
            ec: "Speed measure",
            ea: "Ping",
            ev: testserver.bestPing
          }).send();
        }
        server.innerText =
          testserver.name + ", " + testserver.cc + " — " + testserver.sponsor +
          " (" + Math.round(testserver.bestPing) + "ms, " +
          Math.round(testserver.dist) + "km)";
      });
    });

    function initConfigData() {
      fetchConfigData("config/presets.json")
        .then(json => {
        var selected = false;
        var presetsMenu = document.getElementById("presets-menu");
        var presets = json.presets;
        var currentPreset = getFromProfile("preset");
        Object.keys(presets).forEach(key => {
          var friendlyName = key.replaceAll("_", " ").toProperCase();
          var item = document.createElement("x-menuitem");
          item.setAttribute("value", key);
          var label = document.createElement("x-label");
          label.innerText = friendlyName;
          item.appendChild(label);
          presetsMenu.appendChild(item);
          if (key === currentPreset) {
            item.setAttribute("toggled", null);
          }
        });
        document.getElementById("presets-select")
          .addEventListener("change", (e) => {
            if (!selected) {
              selected = true;
            }
            setToProfile("preset", e.detail.newValue);
            if (visitor) {
              visitor.event("Preset changed", "Changed to " +
                e.detail.newValue).send();
            }
          });
      });
    }

    let latestSha;

    function refreshConfigTarget() {
      var altChannel = settings.get("channel");
      if (altChannel) {
        fetch(
          "https://api.github.com/repositories/69422496/commits?sha=" +
          altChannel +
          "&path=config")
          .then(response => {
            return response.json();
          }).then(json => {
          // Queue up the latest commit to be set when the user applies
          latestSha = json[0].sha;
          setTargetSha(latestSha);
          initConfigData();
        });
      } else if (settings.get("dev-mode")) {
        setTargetSha("");
        initConfigData();
      } else {
        fetch("https://api.github.com/repositories/69422496/tags")
          .then(response => {
            return response.json();
          })
          .then(json => {
            for (let tag of Object.keys(json)) {
              if (json[tag].name === "v" + app.getVersion()) {
                return json[tag];
              }
            }
            let baseVersion = app.getVersion().split("-")[0];
            for (let tag of Object.keys(json)) {
              if (json[tag].name.startsWith(baseVersion)) {
                return json[tag];
              }
            }
            return json[0];
          })
          .then(tag => {
            // Queue up the latest commit to be set when the user applies
            latestSha = tag.commit.sha;
            setTargetSha(latestSha);
            initConfigData();
          });
      }
    }

    firebase.auth().signInAnonymously().catch(function(error) {
      handleException(error);
    });

    let authedUser;

    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        authedUser = user;

        if (visitor) {
          visitor.set("uid", user.uid);
        }

        fetch("https://api.mastercomfig.com/remoteconfig?id=" + user.uid)
          .then(response => {
            return response.json();
          }).then(json => {
            if (!json || !json.channel || json.channel === "") {
              settings.delete("channel");
              refreshConfigTarget();
            } else {
              settings.set("channel", json.channel);
              refreshConfigTarget();
            }
          })
          .catch(() => {
            settings.delete("channel");
            refreshConfigTarget();
          });
      } else {
        settings.delete("channel");
        refreshConfigTarget();
      }
    });
  }
</script>
</body>
</html>
