<!doctype html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="node_modules/xel/themes/material.css">
  <script src="node_modules/xel/xel.min.js"></script>
  <link href="node_modules/bootstrap/dist/css/bootstrap.min.css"
        integrity="sha256-zVUlvIh3NEZRYa9X/qpNY8P1aBy0d4FrI7bhfZSZVwc="
        crossorigin="anonymous" rel="stylesheet">
  <link href="third_party/font/overpass.css" rel="stylesheet">
  <link href="css/app.css" rel="stylesheet">
  <link href="css/settings.css" rel="stylesheet">
  <title>mastercomfig setup</title>
</head>
<body class="bg-light" style="padding-bottom: 40px">
<nav class="navbar navbar-dark bg-dark d-flex align-items-center sticky-top"
     style="-webkit-app-region: drag; border-bottom: 1px solid #141414">
  <div></div>
  <span class="navbar-brand">
    <img src="img/mastercomfig_logo_transparent.png" style="width: 30px;
    height: 30px" class="d-inline-block align-top" alt="">
    mastercomfig
  </span>
  <a href="#">
    <x-icon name="close" skin="titlebar" style="-webkit-app-region: no-drag"
            id="close-btn"></x-icon>
  </a>
</nav>
<div class="container"
     style="margin-top: 20px;overflow-y: scroll; overflow-x: hidden; height: 95vh; padding-bottom: 48px;">
  <h1 class="display-4" id="title">Welcome to mastercomfig!</h1>
  <p class="lead" id="description">We just need some info before we get
                                   started.</p>
  <h3>1.
    <x-icon name="check" skin="success" id="folder-check" hidden></x-icon>
      Select your Team Fortress 2 folder
  </h3>
  <div class="custom-file">
    <input type="file" class="custom-file-input" id="tf2-folder"
           webkitdirectory/>
    <label class="custom-file-label" for="tf2-folder" id="folder-label">Choose
                                                                        folder...</label>
  </div>
  <hr>
  <h3>
    2.
    <x-icon name="check" skin="success" id="speedtest-check" hidden></x-icon>
    Run an internet speed test
  </h3>
  <p>This will be used to calculate optimal values for some networking settings
     .</p>
  <x-button id="speedtest-btn" style="margin-bottom: 4px">Run test</x-button>
  <div id="speedtest">
    <x-progressbar id="speedtest-bar" hidden></x-progressbar>
    <p>
      <small id="status">Clicking run test will access the Speedtest.net service
                         to record your upload speed.
      </small>
    </p>
  </div>
  <p id="upload" hidden><strong>Upload speed:</strong></p>
  <hr>
  <h3>
    3.
    <x-icon name="check" skin="success" id="preset-check" hidden></x-icon>
    Choose a preset
  </h3>
  <x-select id="presets-select" style="width: 200px">
    <x-menu id="presets-menu">
    </x-menu>
  </x-select>
  <br>
  <a class="no-link" href="mastercomfig.html" id="next-link">
    <x-button disabled id="next-btn">Next</x-button>
  </a>
</div>
<script src="js/module.js"></script>
<script src="node_modules/jquery/dist/jquery.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script src="node_modules/popper.js/dist/umd/popper.js"
        integrity="sha256-wqAoCRn9//AnHSl4qbXVhqdvmgFQqN5Elqp4Eb2wOXA="
        crossorigin="anonymous"></script>
<script src="node_modules/bootstrap/dist/js/bootstrap.min.js"
        integrity="sha256-IeI0loa35pfuDxqZbGhQUiZmD2Cywv1/bdqiypGW46o="
        crossorigin="anonymous"></script>
<script src="js/lib.js"></script>
<script src="js/titlebar.js"></script>
<script>
  "use strict";

  var steps = 0;

  function stepProgress(reverse) {
    if (reverse) {
      steps --;
    } else {
      steps++;
    }

    if (steps >= 3) {
      document.getElementById("next-btn").removeAttribute("disabled");
      document.getElementById("next-link").href = "mastercomfig.html";
    } else {
      document.getElementById("next-btn").setAttribute("disabled", null);
      document.getElementById("next-link").href = "#";
    }
  }

  document.getElementById("tf2-folder").addEventListener("change", e => {
    let folder = e.target.files[0].path;
    if (e.target.files[0].name === "Team Fortress 2") {
      document.getElementById("folder-label").innerText = folder;
      settings.set("tf2-folder", folder);
      document.getElementById("folder-check").hidden = false;
      stepProgress();
    } else {
      if (!document.getElementById("folder-check").hidden) {
        stepProgress(true);
        document.getElementById("folder-check").hidden = true;
        settings.delete("tf2-folder");
      }
      document.getElementById("folder-label").innerText =
        "Invalid Team Fortress 2 folder. Please try again.";
    }
  });

  var speedtestBtn = document.getElementById("speedtest-btn");

  speedtestBtn.addEventListener("click", () => {
    const speedtest = require("speedtest-net");
    var test = speedtest({
      pingCount: 10,
      serversUrl: "https://www.speedtest.net/speedtest-servers-static.php"
    });
    var server = document.getElementById("status");
    server.innerText = "Finding server...";

    var bar = document.getElementById("speedtest-bar");
    document.getElementById("speedtest-btn").disabled = true;
    bar.hidden = false;
    bar.removeAttribute("value");

    document.getElementById("speedtest").hidden = false;

    test.on("uploadprogress", progress => {
      bar.setAttribute("value", (parseFloat(progress) / 100).toString());
    });

    test.on("data", data => {
      bar.hidden = true;
      document.getElementById("speedtest").hidden = true;
      speedtestBtn.innerText = "Retry";
      speedtestBtn.disabled = false;
      var speed = data.speeds.upload;
      document.getElementById("upload").hidden = false;
      document.getElementById("upload").innerHTML =
        "<strong>Upload speed:</strong> " + speed + "Mbps";
      settings.set("upload-speed", speed);
      document.getElementById("speedtest-check").hidden = false;
      stepProgress();
    });

    test.on("testserver", testserver => {
      server.innerText =
        testserver.name + ", " + testserver.cc + " â€” " + testserver.sponsor +
        " (" + Math.round(testserver.bestPing) + "ms, " +
        Math.round(testserver.dist) + "km)";
    });
  });

  function initConfigData() {
    fetchConfigData("config/presets.json")
      .then(response => {
        return response.json();
      }).then(json => {
      var selected = false;
      var presetsMenu = document.getElementById("presets-menu");
      var presets = json.presets;
      Object.keys(presets).forEach(key => {
        var friendlyName = key.replaceAll("_", " ").toProperCase();
        var item = document.createElement("x-menuitem");
        item.setAttribute("value", key);
        var label = document.createElement("x-label");
        label.innerText = friendlyName;
        item.appendChild(label);
        presetsMenu.appendChild(item);

      });
      document.getElementById("presets-select")
        .addEventListener("change", (e) => {
          if (!selected) {
            selected = true;
            document.getElementById("preset-check").hidden = false;
            stepProgress();
          }
          settings.set("preset", e.detail.newValue);
        });
    });
  }

  let latestSha;

  function refreshConfigTarget() {
    var altChannel = settings.get("channel");
    if (altChannel) {
      fetch(
        "https://api.github.com/repositories/69422496/commits?sha=" + altChannel +
        "&path=config")
        .then(response => {
          return response.json();
        }).then(json => {
        // Queue up the latest commit to be set when the user applies
        latestSha = json[0].sha;
        setTargetSha(latestSha);
        initConfigData();
      });
    } else if (settings.get("dev-mode")) {
      setTargetSha("");
      initConfigData();
    } else {
      fetch("https://api.github.com/repositories/69422496/tags")
        .then(response => {
          return response.json();
        })
        .then(json => {
          for (let tag of Object.keys(json)) {
            if (json[tag].name === "v" + app.getVersion()) {
              return json[tag];
            }
          }
          return json[0];
        })
        .then(tag => {
          // Queue up the latest commit to be set when the user applies
          latestSha = tag.commit.sha;
          setTargetSha(latestSha);
          initConfigData();
        });
    }
  }

  firebase.auth().signInAnonymously().catch(function(error) {
    console.log(error);
  });

  let authedUser;

  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      authedUser = user;
      fetch("https://api.mastercomfig.com/remoteconfig?id=" + user.uid)
        .then(response => {
          return response.json();
        }).then(json => {
          if (!json || !json.channel || json.channel === "") {
            settings.delete("channel");
            refreshConfigTarget();
          } else {
            settings.set("channel", json.channel);
            refreshConfigTarget();
          }
        })
        .catch(() => {
          settings.delete("channel");
          refreshConfigTarget();
        });
    } else {
      settings.delete("channel");
      refreshConfigTarget();
    }
  });
</script>
</body>
</html>
