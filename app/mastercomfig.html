<!doctype html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="node_modules/xel/themes/material.css">
  <script src="node_modules/xel/xel.min.js"></script>
  <link href="node_modules/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
  <link href="third_party/font/overpass.css" rel="stylesheet">
  <link href="css/app.css" rel="stylesheet">
  <meta charset="UTF-8">
  <title>mastercomfig</title>
</head>
<body>
<nav class="navbar navbar-dark bg-dark d-flex align-items-center sticky-top"
     style="-webkit-app-region: drag; border-bottom: 1px solid #141414">
  <a href="#" id="slider-toggle">
    <x-icon name="menu" skin="titlebar"
            style="-webkit-app-region: no-drag"></x-icon>
  </a>
  <span class="navbar-brand">
    <img src="img/mastercomfig_logo_transparent.png" width="30" height="30"
         class="d-inline-block align-top" alt="">
    mastercomfig
  </span>
  <a href="#">
    <x-icon name="close" skin="titlebar" style="-webkit-app-region: no-drag"
            id="close-btn"></x-icon>
  </a>
</nav>
<ul class="nav flex-column position-fixed bg-dark text-light" id="slider" style="width:
30%; height: 100vh; z-index: 1000; left: -30%; border-right: 1px solid
#141414">
  <li class="nav-item" style="margin-top: 1rem;">
    <a class="nav-link no-link active" href="#">Home</a>
  </li>
  <hr>
  <li class="nav-item">
    <a class="nav-link no-link" href="#">Community</a>
  </li>
  <hr>
  <li class="nav-item">
    <a class="nav-link no-link" href="settings.html" id="settings">Settings</a>
  </li>
  <hr>
  <li class="nav-item">
    <a class="nav-link no-link" href="about.html">About</a>
  </li>
  <hr>
</ul>
<x-tabs id="cat-tabs"></x-tabs>
<div class="container" id="tab-content"
     style="overflow-y: scroll; overflow-x: hidden; height: 75vh; padding-bottom: 48px;"></div>
<nav class="navbar fixed-bottom navbar-light bg-light" style="border-top: 1px
solid #141414">
  <div class="container">
    <div class="ml-auto"></div>
    <x-throbber hidden id="install-ring"></x-throbber>
    <span class="text-info navbar-text" id="config-update" hidden>
      <x-icon name="update"
              style="height: 20px; width: 20px; display: inline-block"></x-icon>
       There's a new config version available, click apply to install!</span>
    <span class="text-success navbar-text" id="apply-success" hidden><x-icon
      name="check" skin="success"
      style="height: 16px; width: 16px"></x-icon> mastercomfig settings successfully applied!</span>
    <button class="btn btn-outline-secondary" style="margin-left: 10px"
            id="apply-btn">Apply
    </button>
  </div>
</nav>
<x-notification id="notification" timeout="4000">
  An error occurred while downloading mastercomfig. Please try again later.
</x-notification>
<script src="js/module.js"></script>
<script src="node_modules/jquery/dist/jquery.min.js"></script>
<script src="node_modules/popper.js/dist/umd/popper.js"></script>
<script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="js/lib.js"></script>
<script src="js/titlebar.js"></script>
<script src="js/dark.js"></script>
<script>
  "use strict";

  // Check for updates available for the config files
  var latestSha = settings.get("config-sha");
  fetch(
    "https://api.github.com/repositories/69422496/commits?sha=beta&path=config")
    .then(response => {
      return response.json();
    }).then(json => {
    // Queue up the latest commit to be set when the user applies
    latestSha = json[0].sha;
    // If we've applied before and that commit is earlier than the latest one, notify for an update
    if (settings.get("config-sha") && settings.get("config-sha") !==
      latestSha) {
      document.getElementById("config-update").hidden = false;
    }
  });

  var currentTab = "";
  var presets = null;

  // Apply button
  document.getElementById("apply-btn").addEventListener("click", () => {
    // Clear UI elements as we start installing the config
    document.getElementById("config-update").hidden = true;
    document.getElementById("apply-btn").disabled = true;
    var ring = document.getElementById("install-ring");
    ring.hidden = false;

    // GitHub API for latest release
    fetch("https://api.github.com/repositories/69422496/releases")
      .then(response => {
        return response.json();
      })
      .then(json => {
        // Get the latest comfig release
        var version = json[0]["tag_name"];
        var vpkPath = settings.get("tf2-folder") +
          "/tf/custom/mastercomfig.vpk";
        // Delete pre-existing VPK to prevent overwrites
        fs.unlink(vpkPath, () => {
          // Download latest VPK to path
          // TODO: cache file per version (use commit hash)
          download("https://github.com/mastercoms/mastercomfig/releases/download/" +
            version + "/mastercomfig.vpk", vpkPath)
            .then(() => {
              // Delete pre-existing client modules file to prevent overwrites
              fs.unlink(settings.get("tf2-folder") +
                "/tf/cfg/client-modules.cfg", () => {
                var modulesStream = fs.createWriteStream(settings.get(
                  "tf2-folder") + "/tf/cfg/client-modules.cfg");
                modulesStream.once("open", () => {
                  // Set the selected preset to define module aliases
                  modulesStream.write("preset_" + settings.get("preset") +
                    "\n");
                  // Realias modules for ones the user has set
                  var modules = settings.get("modules");
                  if (modules) {
                    Object.keys(modules).forEach(category => {
                      Object.keys(modules[category]).forEach(module => {
                        var name = category[0] + "_" + module;
                        modulesStream.write("alias run_" + name + " " + name +
                          "_" +
                          settings.get("modules." + category + "." + module) +
                          "\n");
                      });
                    });
                  }
                  // Define the upload speed module according to user upload
                  var uploadSpeed = settings.get("upload-speed");
                  var rate = "rate " + Math.max(3500, Math.min(1048576,
                    parseFloat((uploadSpeed * 75000).toFixed(7))));
                  var splitpacketRate = ";net_splitpacket_maxrate " +
                    Math.max(3500, Math.min(1048576,
                      parseFloat((uploadSpeed * 50000).toFixed(7))));
                  var maxClearTime = ";net_maxcleartime " + Math.max(0.0000001,
                    parseFloat((0.01288 / uploadSpeed).toFixed(7)));
                  modulesStream.write("alias run_n_upload \"" + rate +
                    splitpacketRate + maxClearTime + "\"\n");
                  modulesStream.end();
                });
              });
              // Delete pre-existing client custom file to prevent overwrites
              fs.unlink(settings.get("tf2-folder") +
                "/tf/cfg/client-custom.cfg", () => {
                var customStream = fs.createWriteStream(settings.get(
                  "tf2-folder") + "/tf/cfg/client-custom.cfg");
                customStream.once("open", () => {
                  fetch(
                    "https://raw.githubusercontent.com/mastercoms/mastercomfig/beta/config/dynamic.json")
                    .then(response => {
                      return response.json();
                    }).then(json => {
                    const dynamics = json.entries;
                    let count = 0;
                    Object.keys(dynamics).forEach(() => {
                      count++;
                    });
                    Object.keys(dynamics).forEach(key => {
                      ipcRenderer.once("dynamic-data-reply", (event, arg) => {
                        Object.keys(dynamics[arg.key]).forEach(dataKey => {
                          if (arg.data.toLowerCase()
                            .startsWith(dataKey.toLowerCase())) {
                            Object.keys(dynamics[arg.key][dataKey])
                              .forEach(cvar => {
                                customStream.write(cvar + " " +
                                  dynamics[arg.key][dataKey][cvar] + "\n");
                              });
                          }
                        });
                        count--;
                        if (count === 0) {
                          if (settings.get("customs")) {
                            Object.keys(settings.get("customs"))
                              .forEach(custom => {
                                var customSetting = settings.get(
                                  "customs")[custom];
                                if (customSetting.used) {
                                  customStream.write(customSetting.entry +
                                    "\n");
                                }
                              });
                            customStream.end();
                          }
                        }
                      });
                      ipcRenderer.send("dynamic-data-request", key);
                    });
                  });
                });
              });
              ring.hidden = true;
              document.getElementById("apply-btn").disabled = false;
              settings.set("config-sha", latestSha);
              var success = document.getElementById("apply-success");
              success.hidden = false;
              setTimeout(() => {
                success.hidden = true;
              }, 1000);
            })
            .catch((err) => {
              ring.hidden = true;
              document.getElementById("notification").innerText = err;
              document.getElementById("notification").opened = true;
              document.getElementById("apply-btn").disabled = false;
            });
        });
      });
  });

  fetch(
    "https://raw.githubusercontent.com/mastercoms/mastercomfig/beta/config/presets.json")
    .then(response => {
      return response.json();
    }).then(json => {
    presets = json.presets;
  }).then(() => {
    fetch(
      "https://raw.githubusercontent.com/mastercoms/mastercomfig/beta/config/modules.json")
      .then(response => {
        return response.json();
      }).then(json => {
      var modules = json.modules;
      fetch(
        "https://raw.githubusercontent.com/mastercoms/mastercomfig/beta/config/customs.json")
        .then(response => {
          return response.json();
        }).then(json => {
        var customs = json.entries;
        var categoryMap = new Map();
        Object.keys(modules).forEach(key => {
          var module = modules[key];
          if (module.hasOwnProperty("hidden") && module["hidden"]) {
            return;
          }

          var catEntryList = key.split(".");
          var category = catEntryList[0];
          var entry = catEntryList[1];

          if (categoryMap.has(category)) {
            categoryMap.get(category).push(entry);
          } else {
            categoryMap.set(category, [entry]);
          }
        });

        var catTabs = document.getElementById("cat-tabs");

        var first = true;

        categoryMap.forEach((value, key) => {
          var keyName = key;
          if (key.charAt(0) !== key.charAt(0).toUpperCase()) {
            keyName = key.toProperCase();
          }

          var item = document.createElement("x-tab");
          item.setAttribute("href", "#" + key + "-card");
          var label = document.createElement("x-label");
          label.innerText = keyName;
          item.appendChild(label);
          catTabs.appendChild(item);

          var tabContent = document.getElementById("tab-content");
          var card = document.createElement("x-card");
          card.id = key + "-card";

          if (first) {
            item.setAttribute("selected", null);
            currentTab = key + "-card";
            first = false;
          } else {
            card.hidden = true;
          }

          item.addEventListener("click", () => {
            document.getElementById(currentTab).hidden = true;
            currentTab = key + "-card";
            card.hidden = false;
          });

          value.forEach((item, index) => {
            var moduleIndex = key + "." + item;
            var module = modules[moduleIndex];
            var friendlyName = "";
            if (module.hasOwnProperty("name")) {
              friendlyName = module["name"];
            } else {
              friendlyName = item.replace("_", " ").toProperCase();
            }

            var accordion = document.createElement("x-accordion");
            var header = document.createElement("header");
            var label = document.createElement("x-label");
            label.style.width = "150px";
            var bold = document.createElement("strong");
            bold.innerText = friendlyName;
            var description = document.createElement("x-label");
            var moduleLevel = settings.get("modules." + moduleIndex);
            if (!moduleLevel) {
              moduleLevel =
                presets[settings.get("preset")]["modules"][moduleIndex];
            }
            var moduleLevelName = "";
            if (module["levels"][moduleLevel].hasOwnProperty("name")) {
              moduleLevelName = module["levels"][moduleLevel]["name"];
            } else {
              moduleLevelName = moduleLevel.replace("_", " ").toProperCase();
            }
            description.innerText = moduleLevelName;
            label.appendChild(bold);
            header.appendChild(label);
            header.appendChild(description);
            accordion.appendChild(header);
            var main = document.createElement("main");
            main.id = key[0] + "_" + item;
            var row = document.createElement("div");
            row.classList.add("row");
            main.appendChild(row);
            var right = document.createElement("div");
            right.classList.add("col-sm");
            if (module.hasOwnProperty("description")) {
              var moduleDescription = document.createElement("p");
              moduleDescription.classList.add("lead");
              moduleDescription.innerText = module["description"];
              right.appendChild(moduleDescription);
            }
            var moduleLevelDescription = document.createElement("p");
            right.appendChild(moduleLevelDescription);
            var left = document.createElement("div");
            left.classList.add("col-sm");
            var moduleSelect = document.createElement("x-select");
            moduleSelect.style.width = "100%";
            left.appendChild(moduleSelect);
            var moduleMenu = document.createElement("x-menu");
            moduleSelect.appendChild(moduleMenu);
            Object.keys(module["levels"]).forEach(key => {
              var moduleMenuItem = document.createElement("x-menuitem");
              moduleMenuItem.setAttribute("value", key);
              if (key === moduleLevel) {
                moduleMenuItem.setAttribute("toggled", null);
                if (module["levels"][key].hasOwnProperty("description")) {
                  moduleLevelDescription.innerText =
                    module["levels"][key]["description"];
                } else {
                  moduleLevelDescription.innerText = "";
                }
              }
              var moduleMenuItemLabel = document.createElement("x-label");
              var moduleName = "";
              if (module["levels"][key].hasOwnProperty("name")) {
                moduleName = module["levels"][key]["name"];
              } else {
                moduleName = key.replace("_", " ").toProperCase();
              }
              moduleMenuItemLabel.innerText = moduleName;
              moduleMenuItem.appendChild(moduleMenuItemLabel);
              moduleMenu.appendChild(moduleMenuItem);
            });
            moduleSelect.addEventListener("change", (e) => {
              var moduleLevel = module["levels"][e.detail.newValue];
              if (moduleLevel.hasOwnProperty("description")) {
                moduleLevelDescription.innerText = moduleLevel["description"];
              } else {
                moduleLevelDescription.innerText = "";
              }
              var moduleLevelName = "";

              if (moduleLevel.hasOwnProperty("name")) {
                moduleLevelName = moduleLevel["name"];
              } else {
                moduleLevelName =
                  e.detail.newValue.replace("_", " ").toProperCase();
              }
              description.innerText = moduleLevelName;

              settings.set("modules." + moduleIndex, e.detail.newValue);
            });
            row.appendChild(left);
            row.appendChild(right);
            accordion.appendChild(main);
            card.appendChild(accordion);
            if (index !== value.length - 1) {
              card.appendChild(document.createElement("hr"));
            }
          });

          tabContent.appendChild(card);
        });
        Object.keys(customs).forEach((item) => {
          var customEntry = customs[item];
          var splitCats = customEntry.category.split(".");
          splitCats = splitCats[0][0] + "_" + splitCats[1];
          var mainSection = document.getElementById(splitCats);
          var itemName = item;
          itemName = itemName.replace("_", " ");
          if (item.charAt(0) !== item.charAt(0).toUpperCase()) {
            itemName = item.toProperCase();
          }
          if (!mainSection.innerHTML.endsWith("<hr>")) {
            mainSection.appendChild(document.createElement("hr"));
          }

          var box = document.createElement("x-box");
          var checkbox = document.createElement("x-checkbox");
          if (settings.get("customs." + splitCats + "_" + item + ".used")) {
            checkbox.setAttribute("toggled", null);
          }
          checkbox.addEventListener("toggle", () => {
            settings.set("customs." + splitCats + "_" + item + ".used",
              checkbox.hasAttribute("toggled"));
          });
          box.appendChild(checkbox);
          var label = document.createElement("x-label");
          box.appendChild(label);
          var controlBox = document.createElement("x-box");
          var labelsDiv = document.createElement("div");
          labelsDiv.style.marginRight = "10px";
          label.appendChild(controlBox);
          controlBox.setAttribute("vertical", null);
          var titleLabel = document.createElement("x-label");
          var title = document.createElement("strong");
          title.innerText = itemName;
          titleLabel.appendChild(title);
          labelsDiv.appendChild(titleLabel);
          if (customEntry.description) {
            var description = document.createElement("x-label");
            description.innerText = customEntry.description;
            labelsDiv.appendChild(description);
          }
          controlBox.appendChild(labelsDiv);
          switch (customEntry.data.type) {
            case "selector":
              var customSelect = document.createElement("x-select");
              box.appendChild(customSelect);
              var customMenu = document.createElement("x-menu");
              customSelect.appendChild(customMenu);
              customEntry.data.value.forEach((selection, index) => {
                var customMenuItem = document.createElement("x-menuitem");
                customMenuItem.setAttribute("value", index);
                var customMenuItemLabel = document.createElement("x-label");
                customMenuItemLabel.innerText =
                  selection.name.replace("_", " ").toProperCase();
                customMenuItem.appendChild(customMenuItemLabel);
                customMenu.appendChild(customMenuItem);
              });
              customSelect.addEventListener("change", (e) => {
                var customLevel = customEntry.data.value[parseInt(
                  e.detail.newValue)];
                settings.set("customs." + splitCats + "_" + item + ".value",
                  parseInt(e.detail.newValue));
                var cvars = "";
                Object.keys(customLevel.values).forEach((cvar, cvarI) => {
                  cvars += (cvarI !== 0 ? ";" : "") + cvar + " " +
                    customLevel.values[cvar];
                });
                settings.set("customs." + splitCats + "_" + item + ".entry",
                  cvars);
              });
              break;
            case "toggle":
              var switcher = document.createElement("x-switch");
              box.appendChild(switcher);
              if (settings.get("customs." + splitCats + "_" + item +
                ".value")) {
                switcher.setAttribute("toggled", null);
              }
              switcher.addEventListener("toggle", () => {
                settings.set("customs." + splitCats + "_" + item + ".value",
                  switcher.hasAttribute("toggled"));
                var cvars = "";
                customEntry.data.value.forEach((cvar, cvarI) => {
                  cvars += (cvarI !== 0 ? ";" : "") + cvar +
                    (switcher.hasAttribute("toggled") ? " 1" : " 0");
                });
                settings.set("customs." + splitCats + "_" + item + ".entry",
                  cvars);
              });
              break;
            case "slider":
            case "stepper":
              var num = document.createElement("x-numberinput");
              var stepper = document.createElement("x-stepper");
              num.appendChild(stepper);
              num.setAttribute("min", customEntry.data.value.min);
              var value = settings.get("customs." + splitCats + "_" + item +
                ".value");
              if (!value) {
                value = customEntry.data.value.min;
              }
              num.value = value;
              num.setAttribute("max", customEntry.data.value.max);
              box.appendChild(num);
              num.addEventListener("change", () => {
                settings.set("customs." + splitCats + "_" + item + ".value",
                  num.getAttribute("value"));
                settings.set("customs." + splitCats + "_" + item +
                  ".entry", customEntry.data.value.cvar + " " +
                  num.getAttribute("value"));
              });
              break;
          }

          mainSection.appendChild(box);
          mainSection.appendChild(document.createElement("hr"));
        });
      });
    });
  });
</script>
</body>
</html>
